#include <iostream>
#include <vector>
#include <chrono>
#include <sstream>
#include <bitset>
#include <string>
#include <thread>
#include <random>
#include <cmath>
#include <functional>
#include <stdlib.h>

using namespace std;
char hx[] = {'0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A', 'B', 'C', 'D', 'E', 'F'};
char bn[] = {'0', '1'};
int nfes = 0;

string hex_string(int lenght)
{
    string out;
    for (int i = 0; i < lenght; i++)
    {

        int rnd = rand() % 16;

        out = out + hx[rnd];
    }
    return out;
}

string binary_string(int lenght)
{
    string out;
    for (int i = 0; i < lenght; i++)
    {

        int rnd = rand() % 2;

        out = out + bn[rnd];
    }
    return out;
}
string hex_to_bin(string in)
{
    long int i = 0;
    string out = "";
    while (in[i])
    {
        switch (in[i])
        {
        case '0':
            out = out + "0000";
            break;
        case '1':
            out = out + "0001";
            break;
        case '2':
            out = out + "0010";
            break;
        case '3':
            out = out + "0011";
            break;
        case '4':
            out = out + "0100";
            break;
        case '5':
            out = out + "0101";
            break;
        case '6':
            out = out + "0110";
            break;
        case '7':
            out = out + "0111";
            break;
        case '8':
            out = out + "1000";
            break;
        case '9':
            out = out + "1001";
            break;
        case 'A':
        case 'a':
            out = out + "1010";
            break;
        case 'B':
        case 'b':
            out = out + "1011";
            break;
        case 'C':
        case 'c':
            out = out + "1100";
            break;
        case 'D':
        case 'd':
            out = out + "1101";
            break;
        case 'E':
        case 'e':
            out = out + "1110";
            break;
        case 'F':
        case 'f':
            out = out + "1111";
            break;
        default:
            cout << "Nepravilen vnos!" << endl;
        }
        i++;
    }
    return out;
}
string bin_to_hex(const string &input)
{
    size_t len = input.length();
    if (len % 4 != 0)
    {
        return "";
    }
    string output = string(len / 4, '0');
    size_t outputoffset = 0;
    for (size_t i = 0; i < len; i += 4)
    {
        int val = 0;
        for (size_t j = 0; j < 4; j++)
        {
            if (input[i + j] == '1')
            {
                val += (1 << (3 - j));
            }
        }
        output[outputoffset++] = hx[val];
    }
    return output;
}

int Ck(string a, int k)
{
    int out = 0;
    for (int i = 0; i < a.size() - k; i++)
    {

        int i1 = CharValue(a[i]);
        int i2 = CharValue(a[i + k]);
        int val = (i1 * i2);
        out += val;
    }
    nfes++;

    return out;
}
int PSL_threaded(string a)
{
    int max = 0;
    for (int k = 1; k <= a.size() - 2; k++)
    {
        if (k == a.size() - 2)
        {
            int val1;
            std::thread t1([&]
                           { val1 = Ck(a, k); });
            t1.join();

            int val2;
            std::thread t2([&]
                           { val2 = Ck(a, k + 1); });
            t2.join();

            if (val1 > max)
            {
                max = val1;
            }
            if (val2 > max)
            {
                max = val2;
            }
        }
        else
        {
            int val1;
            std::thread t1([&]
                           { val1 = Ck(a, k); });
            t1.join();

            int val2;
            std::thread t2([&]
                           { val2 = Ck(a, k + 1); });
            t2.join();

            int val3;
            std::thread t3([&]
                           { val3 = Ck(a, k + 2); });
            t3.join();

            if (val1 > max)
            {
                max = val1;
            }
            if (val2 > max)
            {
                max = val2;
            }
            if (val3 > max)
            {
                max = val3;
            }
        }
    }

    return max;
}
double MF_threaded(string a)
{
    double vsota = 0;

    for (int k = 1; k <= a.size() - 2; k + 3)
    {
        if (k == a.size() - 2)
        {
            int val1;
            std::thread t1([&]
                           { val1 = Ck(a, k); });
            t1.join();
            vsota += (val1 * val1);

            int val2;
            std::thread t2([&]
                           { val2 = Ck(a, k + 1); });
            t2.join();
            vsota += (val2 * val2);
        }
        else
        {

            int val1;
            std::thread t1([&]
                           { val1 = Ck(a, k); });
            t1.join();
            vsota += (val1 * val1);

            int val2;
            std::thread t2([&]
                           { val2 = Ck(a, k + 1); });
            t2.join();
            vsota += (val2 * val2);

            int val3;
            std::thread t3([&]
                           { val3 = Ck(a, k + 2); });
            t3.join();
            vsota += (val3 * val3);
        }
    }
    vsota = vsota * 2;

    double out = (a.size() * a.size()) / (vsota);
    return out;
}

int PSL(string a)
{
    int max = 0;
    for (int k = 1; k < a.size(); k++)
    {
        int val1 = Ck(a, k);
        if (val1 > max)
        {
            max = val1;
        }
    }

    return max;
}
double MF(string a)
{
    double vsota = 0;

    for (int k = 1; k < a.size(); k)
    {
        int val1 = Ck(a, k);
        vsota += (val1 * val1);
    }
    vsota = vsota * 2;

    double out = (a.size() * a.size()) / (vsota);
    return out;
}

double sekvenca(string a, string type)
{
    if (type == "MF")
    {
        return MF(a);
    }
    else if (type == "PSL")
    {
        return PSL(a);
    }
    return
}
string find_neighbour(string a, int poz)
{
    string out = a;
    if (a[poz] == "0")
    {
        out[poz] = "1";
    }
    else if (a[poz] == "1")
    {
        out[poz] = "0";
    }
    return out;
}

int main(int argc, char **argv)
{
    int l = atoi(argv[1]);
    int nfesLmt = atoi(argv[4]);
    string sequence;
    double mf = 0;
    int psl = 0;
    srand(atoi(argv[3]));
    string type = argv[2];
    cout << "start" << endl;
    std::chrono::steady_clock::time_point begin = std::chrono::steady_clock::now();
    string bin = binary_string(l);
    if (type == "MF")
    {
        mf = MF(bin);
    }
    else if (type == "PSL")
    {
        psl = PSL(bin);
    }
    sequence = bin;

    while (nfes < nfesLmt)
    {
        string bin_pivot = binary_string(l);
        string bin_sosed1 = find_neighbour(bin_pivot,l-1);
        string bin_sosed2 = find_neighbour(bin_pivot,l-2);
        if (type == "MF")
        {
            int mf1;
            int mf2;
            int mf3;
            std::thread t1([&]
                           { mf1 = sekvenca(bin_pivot); });
            t1.join();

            td::thread t2([&]
                           { mf2 = sekvenca(bin_sosed1); });
            t2.join();

            td::thread t3([&]
                           { mf3 = sekvenca(bin_sosed2); });
            t3.join();
            if (mf1 > mf)
            {
                mf = mf1;
                sequence = bin;
            }
            if (mf2 > mf)
            {
                mf = mf2;
                sequence = bin_sosed1;
            }
            if (mf3 > mf)
            {
                mf = mf3;
                sequence = bin_sosed2;
            }
        }
        else if (type == "PSL")
        {
            int psl1;
            std::thread t1([&]
                           { psl1 = sekvenca(bin_pivot); });
            t1.join();

            int psl2;
            std::thread t2([&]
                           { psl1 = sekvenca(bin_sosed1); });
            t2.join();

            int psl3;
            std::thread t3([&]
                           { psl1 = sekvenca(bin_sosed2); });
            t3.join();

            if (psl1 < psl)
            {
                psl = psl1;
                sequence = bin_pivot;
            }
            if (psl2 < psl)
            {
                psl = psl2;
                sequence = bin_sosed1;
            }
            if (psl3 < psl)
            {
                psl = psl3;
                sequence = bin_sosed2;
            }
        }
    }

    std::chrono::steady_clock::time_point end = std::chrono::steady_clock::now();
    int runtime = (std::chrono::duration_cast<std::chrono::microseconds>(end - begin).count()) / 1000000.0;
    double speed;
    if (runtime == 0)
    {
        speed = 0;
    }
    else
    {
        speed = nfes / runtime;
    }

    cout << "L: " << l << endl;
    cout << "nfesLmt: " << nfesLmt << endl;
    cout << "seed: " << l << endl;
    cout << "nfes: " << nfes << endl;
    cout << "runtime (sec): " << runtime << endl;
    cout << "speed: " << speed << endl;
    cout << "sequence: " << sequence << endl;
    if (type == "MF")
    {
        cout << "MF: " << mf << endl;
    }
    else if (type == "PSL")
    {
        cout << "PSL: " << psl << endl;
    }
}
